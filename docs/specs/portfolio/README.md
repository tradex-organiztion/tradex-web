# 수익 관리 (Portfolio) 기획/스펙 문서

> **상태**: `작성중`
> **최종 수정**: 2024-12-22
> **담당자**: -

---

## 1. 개요

### 1.1 목적
자산 현황과 손익 데이터를 관리하여 포트폴리오 성과를 추적합니다.

### 1.2 사용자 스토리
- As a 트레이더, I want to 자산 현황 확인, so that 전체 포트폴리오를 파악할 수 있다.
- As a 트레이더, I want to 손익 데이터 확인, so that 매매 성과를 추적할 수 있다.

---

## 2. 기능 요구사항

### 2.1 Assets (자산 관리)

#### 필수 기능 (Must Have)
- [ ] 총 자산 현황 표시
- [ ] 자산별 비중 차트
- [ ] 예상 수익 표시
- [ ] 기간별 자산 변화 그래프

#### 선택 기능 (Nice to Have)
- [ ] 거래소 연동 자동 동기화
- [ ] 자산 목표 설정

### 2.2 P&L (손익 관리)

#### 필수 기능 (Must Have)
- [ ] 실현 손익 표시
- [ ] 미실현 손익 표시
- [ ] 기간별 손익 그래프
- [ ] 종목별 손익 상세

#### 선택 기능 (Nice to Have)
- [ ] 손익 리포트 다운로드
- [ ] 세금 계산 도우미

### 2.3 제외 범위 (Out of Scope)
- 자동 매매 실행
- 세금 신고 연동

---

## 3. 화면 설계

### 3.1 화면 목록

| 화면명 | 경로 | 설명 |
|--------|------|------|
| 자산 현황 | `/portfolio/assets` | 자산 관리 |
| 손익 관리 | `/portfolio/pnl` | P&L 관리 |

### 3.2 화면 구성

#### 자산 현황
```
┌─────────────────────────────────────────────────────────────┐
│ 자산 현황                                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 총 자산                                                     │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                                                         │ │
│ │     ₩ 15,234,567                                       │ │
│ │     +₩ 1,234,567 (+8.8%)  이번 달                      │ │
│ │                                                         │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 자산 구성                                                   │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                                                         │ │
│ │         ████████████████  BTC 45%                       │ │
│ │         ██████████  ETH 28%                             │ │
│ │         ██████  USDT 18%                                │ │
│ │         ███  기타 9%                                    │ │
│ │                                                         │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 자산 변화 추이                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                                            ●            │ │
│ │                                     ●                   │ │
│ │                              ●                          │ │
│ │        ●              ●                                 │ │
│ │  ●                                                      │ │
│ │ ─────────────────────────────────────────────          │ │
│ │ 1월    2월    3월    4월    5월    6월                  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 자산 상세                                                   │
│ ┌──────────┬──────────┬──────────┬──────────┐              │
│ │ 자산     │ 보유량   │ 평가금액 │ 수익률   │              │
│ ├──────────┼──────────┼──────────┼──────────┤              │
│ │ BTC      │ 0.15     │ ₩6.8M   │ +12.5%   │              │
│ │ ETH      │ 2.3      │ ₩4.2M   │ +8.2%    │              │
│ │ ...      │ ...      │ ...      │ ...      │              │
│ └──────────┴──────────┴──────────┴──────────┘              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 손익 관리
```
┌─────────────────────────────────────────────────────────────┐
│ 손익 관리                         기간: [이번 달 ▼]         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 손익 요약                                                   │
│ ┌─────────────────────┐ ┌─────────────────────┐            │
│ │ 실현 손익            │ │ 미실현 손익          │            │
│ │ +₩ 856,000          │ │ +₩ 378,567          │            │
│ │ +5.6%               │ │ +2.5%               │            │
│ └─────────────────────┘ └─────────────────────┘            │
│                                                             │
│ 손익 추이                                                   │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                                                         │ │
│ │     ████                      ████████                  │ │
│ │     ████  ████                ████████  ████████        │ │
│ │ ──────────────────────────────────────────────          │ │
│ │                ████                        ████         │ │
│ │ 1주차  2주차  3주차  4주차  5주차  6주차                │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 종목별 손익                                                 │
│ ┌──────────┬──────────┬──────────┬──────────┐              │
│ │ 종목     │ 매매 수  │ 승률     │ 총 손익  │              │
│ ├──────────┼──────────┼──────────┼──────────┤              │
│ │ BTC      │ 12       │ 66%      │ +₩520K  │              │
│ │ ETH      │ 8        │ 50%      │ +₩180K  │              │
│ │ SOL      │ 5        │ 40%      │ -₩44K   │              │
│ └──────────┴──────────┴──────────┴──────────┘              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 상태별 화면
- **기본 상태**: 데이터 표시
- **로딩 상태**: 스켈레톤 UI
- **빈 상태**: 데이터 입력 유도
- **에러 상태**: 재시도 버튼

---

## 4. 데이터 모델

### 4.1 주요 엔티티

```typescript
// 자산 현황
interface AssetSummary {
  totalValue: number;
  totalValueChange: number;
  totalValueChangePercent: number;
  assets: Asset[];
  history: AssetHistory[];
}

interface Asset {
  symbol: string;
  name: string;
  amount: number;
  value: number;
  allocation: number;
  profitPercent: number;
}

interface AssetHistory {
  date: string;
  totalValue: number;
}

// 손익 데이터
interface PnLSummary {
  realizedPnL: number;
  realizedPnLPercent: number;
  unrealizedPnL: number;
  unrealizedPnLPercent: number;
  history: PnLHistory[];
  bySymbol: SymbolPnL[];
}

interface PnLHistory {
  date: string;
  pnl: number;
}

interface SymbolPnL {
  symbol: string;
  tradeCount: number;
  winRate: number;
  totalPnL: number;
}
```

### 4.2 API 엔드포인트

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/portfolio/assets` | 자산 현황 |
| GET | `/portfolio/assets/history` | 자산 변화 히스토리 |
| GET | `/portfolio/pnl` | 손익 요약 |
| GET | `/portfolio/pnl/history` | 손익 히스토리 |
| GET | `/portfolio/pnl/by-symbol` | 종목별 손익 |

---

## 5. 비즈니스 로직

### 5.1 주요 로직
1. **자산 평가**: 현재가 × 보유량
2. **수익률 계산**: (현재가 - 평균매수가) / 평균매수가 × 100
3. **실현 손익**: 청산된 매매의 손익 합계
4. **미실현 손익**: 보유 중인 포지션의 평가손익

### 5.2 유효성 검사
- 기간 필터: 유효한 날짜 범위

### 5.3 예외 처리
| 에러 코드 | 상황 | 대응 |
|----------|------|------|
| 503 | 시세 조회 실패 | 마지막 캐시 데이터 표시 |

---

## 6. 컴포넌트 설계

### 6.1 컴포넌트 구조

```
components/features/portfolio/
├── assets/
│   ├── AssetSummary.tsx
│   ├── AssetAllocationChart.tsx
│   ├── AssetHistoryChart.tsx
│   └── AssetTable.tsx
├── pnl/
│   ├── PnLSummary.tsx
│   ├── PnLChart.tsx
│   └── SymbolPnLTable.tsx
└── hooks/
    ├── useAssets.ts
    └── usePnL.ts
```

---

## 7. 상태 관리

### 7.1 로컬 상태
- 기간 필터

### 7.2 전역 상태
- N/A

### 7.3 서버 상태 (TanStack Query)
- 자산/손익 데이터 쿼리

---

## 8. 의존성

### 8.1 내부 의존성
- `lib/api/portfolio.ts`

### 8.2 외부 의존성
- `recharts`: 차트
- `react-table`: 테이블

---

## 9. 테스트 계획

### 9.1 단위 테스트
- [ ] 수익률 계산
- [ ] 자산 비중 계산

### 9.2 통합 테스트
- [ ] 데이터 로딩
- [ ] 기간 필터

### 9.3 E2E 테스트
- [ ] 전체 포트폴리오 조회 플로우

---

## 10. 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 0.1 | 2024-12-22 | 초안 작성 | - |

---

## 11. 미결 사항 / 질문

- [ ] 거래소 API 연동 범위
- [ ] 데이터 갱신 주기
- [ ] 세금 계산 기능 필요 여부

---

## 12. 참고 자료

- [User Flow - 수익 관리](../../USER_FLOW.md#310-수익-관리)
- [Architecture](../../ARCHITECTURE.md)
