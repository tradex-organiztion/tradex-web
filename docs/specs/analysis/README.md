# 분석 (Analysis) 기획/스펙 문서

> **상태**: `작성중`
> **최종 수정**: 2024-12-22
> **담당자**: -

---

## 1. 개요

### 1.1 목적
전략 분석과 리스크 매핑을 통해 매매 성과를 분석하고 리스크를 관리합니다.

### 1.2 사용자 스토리
- As a 트레이더, I want to 전략별 성과 분석, so that 효과적인 전략을 파악할 수 있다.
- As a 트레이더, I want to 리스크 시각화, so that 현재 리스크 수준을 직관적으로 파악할 수 있다.

---

## 2. 기능 요구사항

### 2.1 전략 분석 (Strategy)

#### 필수 기능 (Must Have)
- [ ] 변수별 성과 분석 (시간대, 요일, 포지션 등)
- [ ] 분석 결과 차트/테이블 표시
- [ ] 기간별 필터링

#### 선택 기능 (Nice to Have)
- [ ] 분석 리포트 다운로드
- [ ] 비교 분석 (기간별, 전략별)

### 2.2 리스크 매핑 (Risk)

#### 필수 기능 (Must Have)
- [ ] 포트폴리오 리스크 히트맵
- [ ] 리스크 레벨 표시
- [ ] 포지션별 리스크 분포

#### 선택 기능 (Nice to Have)
- [ ] 리스크 알림 설정
- [ ] 시나리오 분석

### 2.3 데이터 보기 (Data)

#### 필수 기능 (Must Have)
- [ ] 원본 데이터 테이블 조회
- [ ] 데이터 필터링
- [ ] 데이터 내보내기 (CSV)

### 2.4 제외 범위 (Out of Scope)
- 실시간 VaR 계산
- 복잡한 파생상품 리스크

---

## 3. 화면 설계

### 3.1 화면 목록

| 화면명 | 경로 | 설명 |
|--------|------|------|
| 전략 분석 | `/analysis/strategy` | 전략별 성과 분석 |
| 리스크 매핑 | `/analysis/risk` | 리스크 시각화 |
| 데이터 보기 | `/analysis/data` | 원본 데이터 조회 |

### 3.2 화면 구성

#### 전략 분석
```
┌─────────────────────────────────────────────────────────────┐
│ 전략 분석                                                   │
├─────────────────────────────────────────────────────────────┤
│ 기간: [1개월 ▼]                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 분석 변수 선택                                              │
│ [시간대] [요일] [포지션] [종목] [진입근거]                  │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 시간대별 수익률                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                                                         │ │
│ │   ■■■■                      ■■■■■■                      │ │
│ │   ■■■■  ■■■■                ■■■■■■  ■■■■                │ │
│ │   ■■■■  ■■■■  ■■■■          ■■■■■■  ■■■■  ■■■■          │ │
│ │ ──────────────────────────────────────────────          │ │
│ │   00-04 04-08 08-12 12-16 16-20 20-24                  │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 상세 데이터                                                 │
│ ┌──────────┬──────────┬──────────┬──────────┐              │
│ │ 시간대   │ 매매 수  │ 승률     │ 평균수익 │              │
│ ├──────────┼──────────┼──────────┼──────────┤              │
│ │ 16-20    │ 45       │ 62%      │ +2.3%    │              │
│ │ 08-12    │ 38       │ 58%      │ +1.8%    │              │
│ │ ...      │ ...      │ ...      │ ...      │              │
│ └──────────┴──────────┴──────────┴──────────┘              │
│                                                             │
│ 💡 인사이트: 16-20시 거래가 가장 높은 수익률을 보입니다     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 리스크 매핑
```
┌─────────────────────────────────────────────────────────────┐
│ 리스크 매핑                                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 현재 리스크 레벨                                            │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │  낮음  [====●=================] 높음                    │ │
│ │              42점 (중간)                                │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 포지션별 리스크 분포                                        │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                                                         │ │
│ │     [BTC]        [ETH]        [SOL]                     │ │
│ │     ████         ██           █                         │ │
│ │     30%          20%          10%                       │ │
│ │                                                         │ │
│ │     리스크: 높음  리스크: 중간  리스크: 낮음             │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 리스크 히트맵                                               │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                                                         │ │
│ │     ██████  ████    ██                                  │ │
│ │     BTC     ETH     SOL   XRP   ...                     │ │
│ │                                                         │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ⚠️ 경고: BTC 포지션이 전체의 30%를 초과했습니다             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 상태별 화면
- **기본 상태**: 분석 결과 표시
- **로딩 상태**: 차트 스켈레톤
- **빈 상태**: 데이터 부족 안내
- **에러 상태**: 재시도 버튼

---

## 4. 데이터 모델

### 4.1 주요 엔티티

```typescript
// 전략 분석 결과
interface StrategyAnalysis {
  variable: 'time' | 'day' | 'position' | 'symbol' | 'reason';
  data: StrategyDataPoint[];
  summary: {
    bestPerforming: string;
    worstPerforming: string;
    insight: string;
  };
}

interface StrategyDataPoint {
  label: string;
  tradeCount: number;
  winRate: number;
  avgProfit: number;
  totalProfit: number;
}

// 리스크 데이터
interface RiskData {
  overallScore: number;
  level: 'low' | 'medium' | 'high';
  positionRisks: PositionRisk[];
  warnings: string[];
}

interface PositionRisk {
  symbol: string;
  allocation: number;
  riskLevel: 'low' | 'medium' | 'high';
  unrealizedPnL: number;
}
```

### 4.2 API 엔드포인트

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | `/analysis/strategy` | 전략 분석 데이터 |
| GET | `/analysis/risk` | 리스크 데이터 |
| GET | `/analysis/data` | 원본 데이터 |
| GET | `/analysis/export` | 데이터 내보내기 |

---

## 5. 비즈니스 로직

### 5.1 주요 로직
1. **전략 분석**: 매매일지 데이터 기반 변수별 집계
2. **리스크 계산**: 포지션 비율, 변동성, 손실률 기반 점수화
3. **인사이트 생성**: 분석 결과 기반 자동 인사이트

### 5.2 유효성 검사
- 분석 기간: 최대 1년
- 최소 데이터: 10건 이상 필요

### 5.3 예외 처리
| 에러 코드 | 상황 | 대응 |
|----------|------|------|
| 400 | 데이터 부족 | 최소 데이터 안내 |

---

## 6. 컴포넌트 설계

### 6.1 컴포넌트 구조

```
components/features/analysis/
├── strategy/
│   ├── StrategyAnalysis.tsx
│   ├── VariableSelector.tsx
│   ├── StrategyChart.tsx
│   └── InsightCard.tsx
├── risk/
│   ├── RiskDashboard.tsx
│   ├── RiskGauge.tsx
│   ├── RiskHeatmap.tsx
│   └── PositionRiskList.tsx
├── data/
│   ├── DataTable.tsx
│   └── DataExport.tsx
└── hooks/
    ├── useStrategyAnalysis.ts
    └── useRiskData.ts
```

---

## 7. 상태 관리

### 7.1 로컬 상태
- 선택된 분석 변수
- 기간 필터

### 7.2 전역 상태
- N/A

### 7.3 서버 상태 (TanStack Query)
- 분석 데이터 쿼리

---

## 8. 의존성

### 8.1 내부 의존성
- `lib/api/analysis.ts`

### 8.2 외부 의존성
- `recharts`: 차트 라이브러리
- `react-table`: 데이터 테이블

---

## 9. 테스트 계획

### 9.1 단위 테스트
- [ ] 리스크 점수 계산
- [ ] 데이터 집계 로직

### 9.2 통합 테스트
- [ ] 분석 데이터 로딩
- [ ] 필터 적용

### 9.3 E2E 테스트
- [ ] 변수 변경 → 차트 업데이트
- [ ] 데이터 내보내기

---

## 10. 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 0.1 | 2024-12-22 | 초안 작성 | - |

---

## 11. 미결 사항 / 질문

- [ ] 분석 변수 추가 여부
- [ ] 리스크 계산 공식 확정
- [ ] 인사이트 AI 생성 여부

---

## 12. 참고 자료

- [User Flow - 전략 분석](../../USER_FLOW.md#37-전략-분석)
- [User Flow - 리스크 매핑](../../USER_FLOW.md#38-리스크-매핑)
- [Architecture](../../ARCHITECTURE.md)
